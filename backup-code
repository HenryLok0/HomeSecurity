#include <SoftwareSerial.h>
#include <ctype.h>   // for tolower()
#include <DHT.h>     // DHT11 library

// ----------------------
// Bluetooth wiring (UNO1)
// BT TXD -> D2 (UNO RX)
// BT RXD -> D3 (UNO TX, via resistor divider)
// ----------------------
const int BT_RX_PIN = 2;  // 接 HC-05 TXD
const int BT_TX_PIN = 3;  // 接 HC-05 RXD

SoftwareSerial BT(BT_RX_PIN, BT_TX_PIN);  // RX, TX

// ----------------------
// DHT11 Sensor (UNO1 - Optional)
// DHT11 DATA -> D5
// ----------------------
#define DHTPIN 5           // DHT11 data pin
#define DHTTYPE DHT11      // DHT11 sensor
DHT dht(DHTPIN, DHTTYPE);
unsigned long lastDhtReadTime = 0;
const unsigned long DHT_READ_INTERVAL = 2000;  // DHT11 needs ~2 seconds between reads

// ----------------------
// Alarm devices on UNO1
// ----------------------
const int buzzerPin = 6;  // HW-512 + -> D6
const int redPin   = 9;   // HW-477 R -> 电阻 -> D9
const int greenPin = 10;  // HW-477 G -> 电阻 -> D10

bool alarmOn = false;
unsigned long lastToggleTime = 0;
const unsigned long alarmInterval = 300;
bool alarmOutputState = false;

// ----------------------
// 处理本地蓝牙指令
// a   = alarm ON
// x   = alarm OFF
// t   = send DHT11 data
// ?   = show help
// ----------------------
void handleLocalBtCommand(char c) {
  char cmd = tolower(c);

  if (cmd == 'a') {
    alarmOn = true;
    BT.println(F("ALARM ON"));
  } else if (cmd == 'x') {
    alarmOn = false;
    BT.println(F("ALARM OFF"));

    alarmOutputState = false;
    digitalWrite(buzzerPin, LOW);
    digitalWrite(redPin, LOW);
    digitalWrite(greenPin, LOW);
  } else if (cmd == 't') {
    // Request DHT11 data
    requestAndSendDHT11();
  } else if (cmd == '?') {
    BT.println(F("Commands:"));
    BT.println(F("  a - alarm ON (buzzer + LED blink)"));
    BT.println(F("  x - alarm OFF"));
    BT.println(F("  t - send DHT11 temperature & humidity"));
    BT.println(F("  ? - show this help"));
  } else {
    // Forward other chars to UNO2 if needed
    Serial.write(c);
  }
}

void setup() {
  // 串口 0：连接 UNO2
  Serial.begin(115200);   // 必须和 UNO2 的 Serial.begin 一致

  // 蓝牙串口
  BT.begin(9600);         // HC-05 默认 9600

  // DHT11 初始化（可选）
  dht.begin();

  // 报警用 IO
  pinMode(buzzerPin, OUTPUT);
  pinMode(redPin, OUTPUT);
  pinMode(greenPin, OUTPUT);

  digitalWrite(buzzerPin, LOW);
  digitalWrite(redPin, LOW);
  digitalWrite(greenPin, LOW);

  alarmOn = false;
  alarmOutputState = false;
  lastToggleTime = millis();

  BT.println(F("UNO1: Bridge ready."));
  BT.println(F("  a/x/? are handled by UNO1 (alarm)."));
  BT.println(F("  t = request DHT11 temperature/humidity"));
  BT.println(F("  other chars will be forwarded to UNO2 (camera)."));
}

void loop() {
  // 1) 从 UNO2 (Serial) 收数据 -> 批量转发到蓝牙
  //    使用缓冲区避免数据丢失
  if (Serial.available()) {
    uint8_t buffer[64]; // 64 字节缓冲区
    int count = 0;
    
    // 读取多个字节到缓冲区
    while (Serial.available() && count < 64) {
      buffer[count++] = Serial.read();
    }
    
    // 批量写入蓝牙
    if (count > 0) {
      BT.write(buffer, count);
    }
  }

  // 2) 从蓝牙收到数据 -> 既要处理本地命令，又可能转发给 UNO2
  while (BT.available()) {
    char c = BT.read();
    if (c == '\r' || c == '\n') {
      // 忽略回车换行
    } else {
      handleLocalBtCommand(c);
    }
  }

  // 3) 报警闪烁逻辑
  unsigned long now = millis();

  if (alarmOn) {
    if (now - lastToggleTime >= alarmInterval) {
      lastToggleTime = now;
      alarmOutputState = !alarmOutputState;

      digitalWrite(buzzerPin, alarmOutputState ? HIGH : LOW);
      digitalWrite(redPin,    alarmOutputState ? HIGH : LOW);
      digitalWrite(greenPin,  alarmOutputState ? HIGH : LOW);
    }
  } else {
    digitalWrite(buzzerPin, LOW);
    digitalWrite(redPin, LOW);
    digitalWrite(greenPin, LOW);
  }
}

// ============================================================================
// DHT11 Helper Functions
// ============================================================================
void requestAndSendDHT11() {
  // Check if enough time has passed (DHT11 requires ~2 seconds between reads)
  unsigned long now = millis();
  if (now - lastDhtReadTime < DHT_READ_INTERVAL) {
    BT.println(F("DHT: Wait a moment..."));
    return;
  }
  
  lastDhtReadTime = now;
  
  // Read humidity and temperature
  float humidity = dht.readHumidity();
  float temperature = dht.readTemperature();  // Celsius
  
  // Check if any reading failed
  if (isnan(humidity) || isnan(temperature)) {
    BT.println(F("DHT ERROR: Failed to read sensor"));
    return;
  }
  
  // Send formatted data to Android via Bluetooth
  // Format: "TEMP=23.5 C, HUM=65.2 %"
  BT.print(F("TEMP="));
  BT.print(temperature, 1);  // 1 decimal place
  BT.print(F(" C, HUM="));
  BT.print(humidity, 1);     // 1 decimal place
  BT.println(F(" %"));
  
  BT.flush();
}